{% extends 'layout.html' %}
{% block title %}Events{% endblock %}
{% block content %}
    <h1>Events</h1>
    <form method="get" class="form-row">
        <div class="col-md-4 mb-2">
            <label for="q">Search</label>
            <input id="q" name="q" type="text" class="form-control" value="{{ request.args['q'] }}">
        </div>
        <div class="col-md-2 d-flex align-items-end mb-2">
            <input type="submit" value="Filter" class="btn btn-primary btn-block">
        </div>
        <div class="offset-md-4 col-md-2 d-flex align-items-end mb-2">
            <a href="{{ url_for('events.create_or_edit') }}" class="btn btn-primary btn-block">Create</a>
        </div>
    </form>
    {% if events|length() > 0 %}
        {% for event in events %}
            <div class="card mb-2">
                <div class="card-body">
                    <h3>{{ event.name }}</h3>
                    <em>{{ event.owner.username }}</em>
                    <p class="card-text">{{ "Start time: " + pyDatetimeToMoment(event.start_time) if event.event_type == EventType.EVENT or event.event_type == EventType.REMINDER else "" }}</p>
                    <p class="card-text">{{ "End time: " + pyDatetimeToMoment(event.end_time) if event.event_type == EventType.EVENT else "" }}</p>
                    <p class="card-text" id="description{{ event.id }}">{{ event.description }}</p>
                    <form>
                        <div id="passwordDiv" class="form-group" style='{{ "display: inline;" if event.event_type == EventType.ENCRYPTED else "display: none;"}}'>
                            <label for="event_password">Password</label>
                            <div class="input-group">
                                <input id="event_password{{ event.id }}" name="event_password" type="password" class="form-control" required>
                            </div>
                        </div>
                        <input type="button" value="Decrypt" onclick="decrypt('{{ event.id }}');" class="btn">
                    </form>
                    <form action="{{ url_for('events.remove', id=event.id) }}" method="post">
                        <a href="{{ url_for('events.create_or_edit', id=event.id) }}" class="btn btn-primary">Edit</a>
                        <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this event?');" class="btn btn-danger">
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p><em>No events found.</em></p>
    {% endif %}

    <script>
    function decrypt(id){
        console.log('{{ url_for("events.decryptReq", id=1) }}')
        let password = new document.getElementById("event_password" + id).value;
        let xhttp = XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                data = JSON.parse(this.responseText);
                document.getElementById("description" + id).innerHTML = data['description'];
            }
        }
        //xhttp.open("POST", 'events/decryptReq/' + id, true);
        //xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        //xhttp.send("event_password=" + password);
    }
    </script>
{% endblock %}

